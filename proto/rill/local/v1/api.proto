syntax = "proto3";
package rill.local.v1;

import "google/protobuf/timestamp.proto";
import "rill/admin/v1/api.proto";
import "validate/validate.proto";

service LocalService {
  // Ping returns the current time.
  rpc Ping(PingRequest) returns (PingResponse) {}

  // GetMetadata returns information about the local Rill instance.
  rpc GetMetadata(GetMetadataRequest) returns (GetMetadataResponse) {}

  // GetVersion returns details about the current and latest available Rill versions.
  rpc GetVersion(GetVersionRequest) returns (GetVersionResponse) {}

  // GitStatus returns the curren status of the local git repo. This is equivalent to doing a `git fetch` followed by running `git status`.
  rpc GitStatus(GitStatusRequest) returns (GitStatusResponse) {}

  // GithubRepoStatus returns info about a Github user account based on the caller's installations. Forwards to admin API of the same name.
  rpc GithubRepoStatus(GithubRepoStatusRequest) returns (GithubRepoStatusResponse) {}

  // GitPull fetches the latest changes from the remote git repo equivalent to `git pull` command.
  // If there are any merge conflicts the pull is aborted.
  // Force can be set to true to force the pull and overwrite any local changes.
  rpc GitPull(GitPullRequest) returns (GitPullResponse) {}
  
  // GitPush pushes the local changes to the remote git repo equivalent to `git push` command.
  // The difference between this and PushTiGithub is that this does not create a new repo.
  // It only pushes the changes to the existing remote repo.
  rpc GitPush(GitPushRequest) returns (GitPushResponse) {}
  
  // PushToGithub create a Git repo from local project and pushed to users git account.
  rpc PushToGithub(PushToGithubRequest) returns (PushToGithubResponse) {}

  // DeployProject deploys the local project to the Rill cloud.
  rpc DeployProject(DeployProjectRequest) returns (DeployProjectResponse) {}

  // RedeployProject updates a deployed project.
  rpc RedeployProject(RedeployProjectRequest) returns (RedeployProjectResponse) {}

  // GetCurrentUser returns the locally logged in user
  rpc GetCurrentUser(GetCurrentUserRequest) returns (GetCurrentUserResponse) {}

  // GetCurrentProject returns the rill cloud project connected to the local project
  // Deprecated: Use ListMatchingProjects instead.
  rpc GetCurrentProject(GetCurrentProjectRequest) returns (GetCurrentProjectResponse) {}

  // ListOrganizationsAndBillingMetadata returns metadata about the current user's orgs.
  rpc ListOrganizationsAndBillingMetadata(ListOrganizationsAndBillingMetadataRequest) returns (ListOrganizationsAndBillingMetadataResponse) {}

  // CreateOrganization creates a new organization
  rpc CreateOrganization(CreateOrganizationRequest) returns (CreateOrganizationResponse) {}

  // ListMatchingProjects returns all remote projects matching the local project name
  rpc ListMatchingProjects(ListMatchingProjectsRequest) returns (ListMatchingProjectsResponse) {}

  // ListProjectsForOrg returns all projects within an org
  rpc ListProjectsForOrg(ListProjectsForOrgRequest) returns (ListProjectsForOrgResponse) {}

  // GetProject returns information about a specific project
  rpc GetProject(GetProjectRequest) returns (GetProjectResponse) {}

  // ListBranches returns all local and remote branches in the git repo.
  rpc ListBranches(ListBranchesRequest) returns (ListBranchesResponse) {}

  // CheckoutBranch switches to a different branch.
  rpc CheckoutBranch(CheckoutBranchRequest) returns (CheckoutBranchResponse) {}

  // CreateBranch creates a new branch from the current HEAD.
  rpc CreateBranch(CreateBranchRequest) returns (CreateBranchResponse) {}

  // DeleteBranch deletes a local branch.
  rpc DeleteBranch(DeleteBranchRequest) returns (DeleteBranchResponse) {}

  // GitMerge merges a source branch into the current branch.
  rpc GitMerge(GitMergeRequest) returns (GitMergeResponse) {}

  // GetCommitHistory returns the commit history for the current branch.
  rpc GetCommitHistory(GetCommitHistoryRequest) returns (GetCommitHistoryResponse) {}

  // GitCommit creates a new commit with all current changes.
  rpc GitCommit(GitCommitRequest) returns (GitCommitResponse) {}

  // PublishBranch pushes a local-only branch to the remote repository for the first time.
  rpc PublishBranch(PublishBranchRequest) returns (PublishBranchResponse) {}

  // DiscardChanges discards all uncommitted changes in the working directory.
  rpc DiscardChanges(DiscardChangesRequest) returns (DiscardChangesResponse) {}

  // CreatePreviewDeployment creates a preview deployment for the current branch.
  rpc CreatePreviewDeployment(CreatePreviewDeploymentRequest) returns (CreatePreviewDeploymentResponse) {}

  // ListPreviewDeployments lists all preview deployments for the project.
  rpc ListPreviewDeployments(ListPreviewDeploymentsRequest) returns (ListPreviewDeploymentsResponse) {}

  // DeletePreviewDeployment deletes a preview deployment.
  rpc DeletePreviewDeployment(DeletePreviewDeploymentRequest) returns (DeletePreviewDeploymentResponse) {}
}

message PingRequest {}

message PingResponse {
  google.protobuf.Timestamp time = 1;
}

message GetMetadataRequest {}

message GetMetadataResponse {
  string instance_id = 1;
  string project_path = 2;
  string install_id = 3;
  string user_id = 4;
  string version = 5;
  string build_commit = 6;
  string build_time = 7;
  bool is_dev = 8;
  bool analytics_enabled = 9;
  bool readonly = 10;
  int32 grpc_port = 11;
  string login_url = 12;
  string admin_url = 13;
}

message GetVersionRequest {}

message GetVersionResponse {
  string current = 1;
  string latest = 2;
}

message GitStatusRequest {}

message GitStatusResponse {
  // The current branch of the git repo.
  string branch = 1;
  // The remote url of the git repo.
  string github_url = 2;
  // Subpath relative to the git repo root. This is where the project is started.
  string subpath = 7;
  // If the repo is managed by Rill.
  bool managed_git = 3;
  // local_changes returns true if there are any staged, unstaged, or untracked changes in the local git repo.
  bool local_changes = 4;
  // local_commits returns number of local commits that are not pushed to the remote git repo.
  int32 local_commits = 5;
  // remote_commits returns number of remote commits not pulled yet.
  int32 remote_commits = 6;
  // has_upstream returns true if the current branch has a remote tracking branch.
  bool has_upstream = 8;
}

message GithubRepoStatusRequest {
  string remote = 1;
}

message GithubRepoStatusResponse {
  bool has_access = 1;
  string grant_access_url = 2;
  string default_branch = 3;
}

message GitPullRequest {
  bool discard_local = 1;
}

message GitPullResponse {
  // The output of the git pull command. Only set for unsuccessful pulls.
  string output = 1; 
}

message GitPushRequest {
  string commit_message = 1;
  bool force = 2;
}

message GitPushResponse {}

message PushToGithubRequest {
  string account = 1;
  string repo = 2;
}

message PushToGithubResponse {
  string remote = 1;
  string account = 2;
  string repo = 3;
}

message DeployProjectRequest {
  string org = 1;
  string new_org_display_name = 4;
  string project_name = 2;
  bool upload = 3;
  // temporarily used for testing
  bool archive = 5;
}

message DeployProjectResponse {
  string deploy_id = 1;
  string org = 2;
  string project = 3;
  string frontend_url = 4;
}

message RedeployProjectRequest {
  string project_id = 1;
  bool reupload = 2;
  // temporarily used for testing
  bool rearchive = 3;
  bool create_managed_repo = 4;
}

message RedeployProjectResponse {
  string frontend_url = 1;
}

message GetCurrentUserRequest {}

message GetCurrentUserResponse {
  admin.v1.User user = 1;
  repeated string rill_user_orgs = 2;
  bool is_representing_user = 3;
}

message GetCurrentProjectRequest {}

message GetCurrentProjectResponse {
  string local_project_name = 1;
  admin.v1.Project project = 2;
}

message ListOrganizationsAndBillingMetadataRequest {}

message ListOrganizationsAndBillingMetadataResponse {
  message OrgMetadata {
    string name = 1;
    repeated admin.v1.BillingIssue issues = 3;
  }

  repeated OrgMetadata orgs = 1;
}

message CreateOrganizationRequest {
  string name = 1 [(validate.rules).string.min_len = 1];
  string description = 2;
  string display_name = 3;
}

message CreateOrganizationResponse {
  admin.v1.Organization organization = 1;
}

message ListMatchingProjectsRequest {}

message ListMatchingProjectsResponse {
  repeated admin.v1.Project projects = 1;
}

message ListProjectsForOrgRequest {
  string org = 1 [(validate.rules).string.min_len = 1];
  uint32 page_size = 2 [(validate.rules).uint32 = {ignore_empty: true, lte: 1000}];
  string page_token = 3;
}

message ListProjectsForOrgResponse {
  repeated admin.v1.Project projects = 1;
}

message GetProjectRequest {
  string organization_name = 1;
  string name = 2;
}

message GetProjectResponse {
  admin.v1.Project project = 1;
  admin.v1.ProjectPermissions project_permissions = 4;
}

// Branch information with sync status and deployment mapping
message BranchInfo {
  // Name of the branch
  string name = 1;
  // Whether the branch exists locally
  bool is_local = 2;
  // Whether the branch exists on remote
  bool is_remote = 3;
  // Whether this is the currently checked out branch
  bool is_current = 4;
  // Short hash of the last commit on this branch
  string last_commit_hash = 5;
  // Message of the last commit
  string last_commit_message = 6;
  // Timestamp of the last commit
  google.protobuf.Timestamp last_commit_time = 7;
  // Number of commits ahead of remote
  int32 ahead = 8;
  // Number of commits behind remote
  int32 behind = 9;
}

message ListBranchesRequest {}

message ListBranchesResponse {
  // All branches (local and remote)
  repeated BranchInfo branches = 1;
  // Name of the current branch
  string current_branch = 2;
  // Whether the repo has uncommitted changes
  bool has_uncommitted_changes = 3;
}

message CheckoutBranchRequest {
  // Name of the branch to checkout
  string branch = 1 [(validate.rules).string.min_len = 1];
  // Force checkout even if there are uncommitted changes (will discard them)
  bool force = 2;
}

message CheckoutBranchResponse {}

message CreateBranchRequest {
  // Name of the new branch
  string name = 1 [(validate.rules).string.min_len = 1];
  // Whether to checkout the new branch after creating it
  bool checkout = 2;
}

message CreateBranchResponse {
  // The created branch info
  BranchInfo branch = 1;
}

message DeleteBranchRequest {
  // Name of the branch to delete
  string name = 1 [(validate.rules).string.min_len = 1];
  // Force delete even if the branch is not fully merged
  bool force = 2;
}

message DeleteBranchResponse {}

message GitMergeRequest {
  // The branch to merge into the current branch
  string source_branch = 1 [(validate.rules).string.min_len = 1];
}

message GitMergeResponse {
  // Whether the merge was successful
  bool success = 1;
  // Whether there were conflicts
  bool has_conflicts = 2;
  // List of files with conflicts
  repeated string conflicting_files = 3;
  // URL to create a pull request (if conflicts exist and remote is GitHub)
  string pull_request_url = 4;
}

// Commit information for history display
message CommitInfo {
  // Full commit hash
  string hash = 1;
  // Short commit hash (first 7 characters)
  string short_hash = 2;
  // Commit message
  string message = 3;
  // Author name
  string author_name = 4;
  // Author email
  string author_email = 5;
  // Commit timestamp
  google.protobuf.Timestamp timestamp = 6;
}

message GetCommitHistoryRequest {
  // Branch to get history for (defaults to current branch if empty)
  string branch = 1;
  // Maximum number of commits to return (defaults to 50)
  int32 limit = 2;
  // Offset for pagination
  int32 offset = 3;
}

message GetCommitHistoryResponse {
  // List of commits
  repeated CommitInfo commits = 1;
  // Total number of commits on the branch
  int32 total_count = 2;
}

message GitCommitRequest {
  // Commit message (required)
  string message = 1 [(validate.rules).string.min_len = 1];
}

message GitCommitResponse {
  // The created commit info
  CommitInfo commit = 1;
}

message PublishBranchRequest {}

message PublishBranchResponse {
  // The branch that was published
  string branch = 1;
  // The remote URL where the branch was published
  string remote_url = 2;
}

message DiscardChangesRequest {
  // If true, only discard specific files. If empty, discard all changes.
  repeated string paths = 1;
}

message DiscardChangesResponse {}

// Preview deployment messages
message CreatePreviewDeploymentRequest {
  // Organization name (required)
  string org = 1 [(validate.rules).string.min_len = 1];
  // Project name (required)
  string project = 2 [(validate.rules).string.min_len = 1];
}

message CreatePreviewDeploymentResponse {
  // The deployment ID
  string deployment_id = 1;
  // The frontend URL for the preview
  string frontend_url = 2;
  // The branch that was deployed
  string branch = 3;
}

message ListPreviewDeploymentsRequest {
  // Organization name (required)
  string org = 1 [(validate.rules).string.min_len = 1];
  // Project name (required)
  string project = 2 [(validate.rules).string.min_len = 1];
}

message PreviewDeploymentInfo {
  // The deployment ID
  string id = 1;
  // The branch name
  string branch = 2;
  // The deployment status
  string status = 3;
  // The frontend URL
  string frontend_url = 4;
  // When the deployment was created
  google.protobuf.Timestamp created_on = 5;
}

message ListPreviewDeploymentsResponse {
  // List of preview deployments
  repeated PreviewDeploymentInfo deployments = 1;
}

message DeletePreviewDeploymentRequest {
  // Organization name (required)
  string org = 1 [(validate.rules).string.min_len = 1];
  // Project name (required)
  string project = 2 [(validate.rules).string.min_len = 1];
  // Deployment ID to delete
  string deployment_id = 3 [(validate.rules).string.min_len = 1];
}

message DeletePreviewDeploymentResponse {
  // The deleted deployment ID
  string deployment_id = 1;
}
