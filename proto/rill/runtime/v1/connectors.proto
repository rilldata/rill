syntax = "proto3";
package rill.runtime.v1;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "rill/runtime/v1/schema.proto";
import "validate/validate.proto";

service ConnectorService {
 // ListBuckets lists buckets accessible with the configured credentials.
  rpc ListBuckets(ListBucketsRequest) returns (ListBucketsResponse) {
    option (google.api.http) = {
      get: "/v1/instances/{instance_id}/connectors/{connector}/buckets"
    };
  }

  // ListObjects lists objects for the given bucket.
  rpc ListObjects(ListObjectsRequest) returns (ListObjectsResponse) {
    option (google.api.http) = {
      get: "/v1/instances/{instance_id}/connectors/{connector}/buckets/{bucket}/objects"
    };
  }

  // OLAPListTables list all tables across all databases in an OLAP
  rpc OLAPListTables(OLAPListTablesRequest) returns (OLAPListTablesResponse) {
    option (google.api.http) = {get: "/v1/olap/tables"};
  }

  // OLAPGetTable returns metadata about a table or view in an OLAP
  rpc OLAPGetTable(OLAPGetTableRequest) returns (OLAPGetTableResponse) {
    option (google.api.http) = {get: "/v1/connectors/olap/table"};
  }

  // ListDatabaseSchemas list all schemas across databases 
  rpc ListDatabaseSchemas(ListDatabaseSchemasRequest) returns (ListDatabaseSchemasResponse) {
    option (google.api.http) = {get: "/v1/connectors/database_schemas"};
  }

  // ListTables list all tables for database and database_schema provided
  rpc ListTables(ListTablesRequest) returns (ListTablesResponse) {
    option (google.api.http) = {get: "/v1/connectors/tables"};
  }

  // GetTable returns metadata about a table or view
  rpc GetTable(GetTableRequest) returns (GetTableResponse) {
    option (google.api.http) = {get: "/v1/connectors/table_metadata"};
  }

}

message ListBucketsRequest {
  string instance_id = 1;
  string connector = 2;
  uint32 page_size = 3;
  string page_token = 4;
}

message ListBucketsResponse {
  string next_page_token = 1;
  repeated string buckets = 2;
}

message ListObjectsRequest {
  string instance_id = 1;
  string connector = 2;
  string bucket = 3 [(validate.rules).string.min_len = 1];
  string path = 4;
  string delimiter = 5;
  uint32 page_size = 6 [(validate.rules).uint32 = {ignore_empty: true, lte: 100}];
  string page_token = 7;
}

message ListObjectsResponse {
  string next_page_token = 1;
  repeated Object objects = 2;
}

message Object {
  string name = 1;
  google.protobuf.Timestamp modified_on = 2;
  int64 size = 3;
  bool is_dir = 4;
}

message OLAPListTablesRequest {
  string instance_id = 1;
  // Connector to list tables from.
  string connector = 2;
  // Optional search pattern to filter tables by.
  // Has the same syntax and behavior as ILIKE in SQL.
  // If the connector supports schema/database names, it searches against both the plain table name and the fully qualified table name.
  string search_pattern = 3;
  uint32 page_size = 4 [(validate.rules).uint32 = {ignore_empty: true, lte: 100}];
  string page_token = 5;

}

message OLAPListTablesResponse {
  repeated OlapTableInfo tables = 1;
  string next_page_token = 2;
}

message OlapTableInfo { 
  string database = 1;
  string database_schema = 4;
  bool is_default_database = 5;
  bool is_default_database_schema = 6;
  string name = 2;
  // has_unsupported_data_types indicates if the underlying table has any column with an unsupported OLAP engine datatype
  bool has_unsupported_data_types = 3;
  // physical_size_bytes is the physical size of the table. Set to -1 if the size cannot be determined.
  int64 physical_size_bytes = 7;
}

message OLAPGetTableRequest {
  string instance_id = 1;
  string connector = 2;
  string database = 4;
  string database_schema = 5;
  string table = 3;
}

message OLAPGetTableResponse {
  StructType schema = 1;
  // unsupported_columns are columns having datatypes which are not supported by Rill
  map<string, string> unsupported_columns = 3;
  bool view = 2;
  // physical_size_bytes is the physical size of the table. Set to -1 if the size cannot be determined.
  int64 physical_size_bytes = 4;
}

message ListDatabaseSchemasRequest {
  string instance_id = 1;
  string connector = 2;
  uint32 page_size = 3 [(validate.rules).uint32 = {ignore_empty: true, lte: 100}];
  string page_token = 4;
}

message ListDatabaseSchemasResponse {
  repeated DatabaseSchemaInfo database_schemas = 1;
  string next_page_token = 2;
}

message DatabaseSchemaInfo {
  string database = 1;
  string database_schema = 2;
}

message ListTablesRequest {
  string instance_id = 1;
  string connector = 2;
  string database = 3;
  string database_schema = 4;
  uint32 page_size = 5 [(validate.rules).uint32 = {ignore_empty: true, lte: 100}];
  string page_token = 6;
}

message ListTablesResponse {
  repeated TableInfo tables = 1;
  string next_page_token = 2;
}

message TableInfo { 
  string name = 1;
  bool view = 2;
}

message GetTableRequest {
  string instance_id = 1;
  string connector = 2;
  string database = 4;
  string database_schema = 5;
  string table = 3;
}

message GetTableResponse {
  map<string, string> schema = 1;
}