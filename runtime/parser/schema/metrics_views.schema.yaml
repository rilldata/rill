$schema: 'http://json-schema.org/draft-07/schema#'
$id: metrics_views.schema.yaml
title: Metrics Views YAML
type: object
description: In your Rill project directory, create a metrics view, `<metrics_view>.yaml`, file in the `metrics` directory. Rill will ingest the metric view definition next time you run `rill start`.
allOf:
  - title: Properties
    type: object
    properties:
      type:
        type: string
        const: metrics_view
        description: Refers to the resource type and must be `metrics_view`
      display_name:
        type: string
        description: Refers to the display name for the metrics view
      description:
        type: string
        description: Refers to the description for the metrics view
      ai_instructions:
        type: string
        description: Extra instructions for AI agents. Used to guide natural language question answering and routing.
      model:
        type: string
        description: Refers to the model powering the dashboard (either model or table is required)
      database:
        type: string
        description: Refers to the database to use in the OLAP engine (to be used in conjunction with table). Otherwise, will use the default database or schema if not specified
      database_schema:
        type: string
        description: Refers to the schema to use in the OLAP engine (to be used in conjunction with table). Otherwise, will use the default database or schema if not specified
      table:
        type: string
        description: Refers to the table powering the dashboard, should be used instead of model for dashboards create from external OLAP tables (either table or model is required)
      timeseries:
        type: string
        description: Refers to the timestamp column from your model that will underlie x-axis data in the line charts. If not specified, the line charts will not appear
      watermark:
        type: string
        description: A SQL expression that tells us the max timestamp that the metrics are considered valid for. Usually does not need to be overwritten
      smallest_time_grain:
        type: string
        description: 'Refers to the smallest time granularity the user is allowed to view. The valid values are: millisecond, second, minute, hour, day, week, month, quarter, year'
      first_day_of_week:
        type: integer
        description: Refers to the first day of the week for time grain aggregation (for example, Sunday instead of Monday). The valid values are 1 through 7 where Monday=1 and Sunday=7
      first_month_of_year:
        type: integer
        description: Refers to the first month of the year for time grain aggregation. The valid values are 1 through 12 where January=1 and December=12
      dimensions:
        type: array
        description: Relates to exploring segments or dimensions of your data and filtering the dashboard
        items:
          type: object
          properties:
            name:
              type: string
              description: a stable identifier for the dimension
            display_name:
              type: string
              description: a display name for your dimension
            description:
              type: string
              description: a freeform text description of the dimension
            column:
              type: string
              description: a categorical column
            expression:
              type: string
              description: a non-aggregate expression such as string_split(domain, '.'). One of column and expression is required but cannot have both at the same time
            unnest:
              type: boolean
              description: if true, allows multi-valued dimension to be unnested (such as lists) and filters will automatically switch to "contains" instead of exact match 
            uri:
              type:
                - string
                - boolean
              description: enable if your dimension is a clickable URL to enable single click navigation (boolean or valid SQL expression) 
          anyOf:
            - required:
                - column
            - required:
                - expression
      measures:
        type: array
        description: Used to define the numeric aggregates of columns from your data model
        items:
          type: object
          properties:
            name:
              type: string
              description: a stable identifier for the measure
            display_name:
              type: string
              description: the display name of your measure.
            description:
              type: string
              description: a freeform text description of the dimension
            type:
              type: string
              description: 'Measure calculation type: "simple" for basic aggregations, "derived" for calculations using other measures, or "time_comparison" for period-over-period analysis. Defaults to "simple" unless dependencies exist.'
            expression:
              type: string
              description: a combination of operators and functions for aggregations
            window:
              description: A measure window can be defined as a keyword string (e.g. 'time' or 'all') or an object with detailed window configuration.
              anyOf:
                - type: string
                  enum:
                    - time
                    - 'true'
                    - all
                  description: 'Shorthand: `time` or `true` means time-partitioned, `all` means non-partitioned.'
                - type: object
                  description: 'Detailed window configuration for measure calculations, allowing control over partitioning, ordering, and frame definition.'
                  properties:
                    partition:
                      type: boolean
                      description: 'Controls whether the window is partitioned. When true, calculations are performed within each partition separately.'
                    order:
                      $ref: '#/definitions/metrics_view/definitions/field_selectors_properties'
                      description: 'Specifies the fields to order the window by, determining the sequence of rows within each partition.'
                    frame:
                      type: string
                      description: 'Defines the window frame boundaries for calculations, specifying which rows are included in the window relative to the current row.'
                  additionalProperties: false
            per:
              $ref: '#/definitions/metrics_view/definitions/field_selectors_properties'
              description: for per dimensions
            requires:
              $ref: '#/definitions/metrics_view/definitions/field_selectors_properties'
              description: using an available measure or dimension in your metrics view to set a required parameter, cannot be used with simple measures
            format_preset:
              type: string
              description: |
                Controls the formatting of this measure using a predefined preset. Measures cannot have both `format_preset` and `format_d3`. If neither is supplied, the measure will be formatted using the `humanize` preset by default.
                
                  Available options:
                  - `humanize`: Round numbers into thousands (K), millions(M), billions (B), etc.
                  - `none`: Raw output.
                  - `currency_usd`: Round to 2 decimal points with a dollar sign ($).
                  - `currency_eur`: Round to 2 decimal points with a euro sign (â‚¬).
                  - `percentage`: Convert a rate into a percentage with a % sign.
                  - `interval_ms`: Convert milliseconds into human-readable durations like hours (h), days (d), years (y), etc. (optional)
            format_d3:
              type: string
              description: 'Controls the formatting of this measure using a [d3-format](https://d3js.org/d3-format) string. If an invalid format string is supplied, the measure will fall back to `format_preset: humanize`. A measure cannot have both `format_preset` and `format_d3`. If neither is provided, the humanize preset is used by default. Example: `format_d3: ".2f"` formats using fixed-point notation with two decimal places. Example: `format_d3: ",.2r"` formats using grouped thousands with two significant digits. (optional)'
            format_d3_locale:
              type: object
              description: locale configuration passed through to D3, enabling changing the currency symbol among other things. For details, see the docs for D3's [formatLocale](https://d3js.org/d3-format#formatLocale)
              additionalProperties: true
            valid_percent_of_total:
              type: boolean
              description: a boolean indicating whether percent-of-total values should be rendered for this measure 
            treat_nulls_as:
              type: string
              description: used to configure what value to fill in for missing time buckets. This also works generally as COALESCING over non empty time buckets.
          minItems: 1
        security:
          $ref: '#/definitions/security_policy_properties'
          description: Defines a security policy for the dashboard
      required:
        - type
  - $ref: '#/definitions/common_properties'
definitions:
  security_policy_properties:
    type: object
    description: Defines security rules and access control policies for resources
    properties:
      access:
        oneOf:
          - type: string
            description: SQL expression that evaluates to a boolean to determine access
          - type: boolean
            description: Direct boolean value to allow or deny access
        description: Expression indicating if the user should be granted access to the dashboard. If not defined, it will resolve to false and the dashboard won't be accessible to anyone. Needs to be a valid SQL expression that evaluates to a boolean.
      row_filter:
        type: string
        description: SQL expression to filter the underlying model by. Can leverage templated user attributes to customize the filter for the requesting user. Needs to be a valid SQL expression that can be injected into a WHERE clause
      include:
        type: array
        description: List of dimension or measure names to include in the dashboard. If include is defined all other dimensions and measures are excluded
        items:
          type: object
          properties:
            if:
              type: string
              description: Expression to decide if the column should be included or not. It can leverage templated user attributes. Needs to be a valid SQL expression that evaluates to a boolean
            names:
              anyOf:
                - type: array
                  description: List of specific field names to include
                  items:
                    type: string
                - type: string
                  description: Wildcard '*' to include all fields
                  enum:
                    - '*'
              description: List of fields to include. Should match the name of one of the dashboard's dimensions or measures
          required:
            - if
            - names
      exclude:
        type: array
        description: List of dimension or measure names to exclude from the dashboard. If exclude is defined all other dimensions and measures are included
        items:
          type: object
          properties:
            if:
              type: string
              description: Expression to decide if the column should be excluded or not. It can leverage templated user attributes. Needs to be a valid SQL expression that evaluates to a boolean
            names:
              anyOf:
                - type: array
                  description: List of specific field names to exclude
                  items:
                    type: string
                - type: string
                  description: Wildcard '*' to exclude all fields
                  enum:
                    - '*'
              description: List of fields to exclude. Should match the name of one of the dashboard's dimensions or measures
          required:
            - if
            - names
      rules:
        type: array
        description: List of detailed security rules that can be used to define complex access control policies
        items:
          type: object
          description: Individual security rule definition
          properties:
            type:
              type: string
              enum:
                - access
                - field_access
                - row_filter
              description: Type of security rule - access (overall access), field_access (field-level access), or row_filter (row-level filtering)
            action:
              type: string
              enum:
                - allow
                - deny
              description: Whether to allow or deny access for this rule
            if:
              type: string
              description: Conditional expression that determines when this rule applies. Must be a valid SQL expression that evaluates to a boolean
            names:
              type: array
              items:
                type: string
              description: List of field names this rule applies to (for field_access type rules)
            all:
              type: boolean
              description: When true, applies the rule to all fields (for field_access type rules)
            sql:
              type: string
              description: SQL expression for row filtering (for row_filter type rules)
          required:
            - type
  common_properties:
    type: object
    title: "Common Properties"
    properties:
      name:
        type: string
        description: Name is usually inferred from the filename, but can be specified manually.
      refs:
        type: array
        description: 'List of resource references'
        items:
          type: string
          description: A string reference like `<resource-name>` or `<type/resource-name>`.
      dev:
        type: object
        description: Overrides any properties in development environment.
      prod:
        type: object
        description: Overrides any properties in production environment.
  metrics_view:
    definitions:
      field_selectors_properties:
        anyOf:
          - type: string
            description: 'Simple field name as a string.'
          - type: array
            description: 'List of field selectors, each can be a string or an object with detailed configuration.'
            items:
              anyOf:
                - type: string
                  description: 'Shorthand field selector, interpreted as the name.'
                - type: object
                  description: 'Detailed field selector configuration with name and optional time grain.'
                  properties:
                    name:
                      type: string
                      description: 'Name of the field to select.'
                    time_grain:
                      type: string
                      description: 'Time grain for time-based dimensions.'
                      enum:
                        - ''
                        - ms
                        - millisecond
                        - s
                        - second
                        - min
                        - minute
                        - h
                        - hour
                        - d
                        - day
                        - w
                        - week
                        - month
                        - q
                        - quarter
                        - 'y'
                        - year
                  required:
                    - name
                  additionalProperties: false
            minItems: 1 