connectors:
  - clickhouse
  - druid
project_files:
  clickhouse_data.yaml:
    type: model
    connector: clickhouse
    output: clickhouse
    sql: |
      select parseDateTimeBestEffort('2024-01-01T00:00:00Z') as time, 'DK' as country, 1 as val union all
      select parseDateTimeBestEffort('2024-01-02T00:00:00Z') as time, 'US' as country, 2 as val union all
      select parseDateTimeBestEffort('2024-01-03T00:00:00Z') as time, 'US' as country, 3 as val union all
      select parseDateTimeBestEffort('2024-01-04T00:00:00Z') as time, 'US' as country, 4 as val union all
      select parseDateTimeBestEffort('2024-01-05T00:00:00Z') as time, 'DK' as country, 5 as val
  duckdb_data.yaml:
    type: model
    connector: duckdb
    sql: |
      select '2024-01-01T00:00:00Z'::TIMESTAMP as time, 'DK' as country, 1 as val union all
      select '2024-01-02T00:00:00Z'::TIMESTAMP as time, 'US' as country, 2 as val union all
      select '2024-01-03T00:00:00Z'::TIMESTAMP as time, 'US' as country, 3 as val union all
      select '2024-01-04T00:00:00Z'::TIMESTAMP as time, 'US' as country, 4 as val union all
      select '2024-01-05T00:00:00Z'::TIMESTAMP as time, 'DK' as country, 5 as val
  simple_duckdb_annotation.yaml:
    type: model
    connector: duckdb
    sql: |
      select '2024-01-05T00:00:00Z' as time, '1st event' as description
      union all
      select '2024-02-16T00:00:00Z' as time, '2nd event' as description
      union all
      select '2024-03-27T00:00:00Z' as time, '3rd event' as description
  time_end_clickhouse_annotation.yaml:
    type: model
    connector: clickhouse
    output: clickhouse
    sql: |
      select '2024-01-05T00:00:00Z' as time, '2024-01-09T00:00:00Z' as time_end, '1st event' as description
      union all
      select '2024-02-16T00:00:00Z' as time, '2024-02-20T00:00:00Z' as time_end, '2nd event' as description
      union all
      select '2024-03-27T00:00:00Z' as time, '2024-04-11T00:00:00Z' as time_end, '3rd event' as description
  grain_duckdb_annotation.yaml:
    type: model
    connector: duckdb
    sql: |
      select '2024-01-05T00:00:00Z' as time, 'day' as grain, '1st event' as description
      union all
      select '2024-02-16T00:00:00Z' as time, 'month' as grain, '2nd event' as description
      union all
      select '2024-03-27T00:00:00Z' as time, 'hour' as grain, '3rd event' as description
  duckdb_metrics.yaml:
    type: metrics_view
    model: duckdb_data
    timeseries: time
    dimensions:
      - column: country
    measures:
      - name: count
        expression: count(*)
      - name: sum
        expression: sum(val)
    annotations:
      - model: simple_duckdb_annotation
      - table: time_end_clickhouse_annotation
        connector: clickhouse
      - model: grain_duckdb_annotation
tests:
  - name: query_simple_duckdb_annotations
    resolver: annotations
    properties:
      metrics_view: duckdb_metrics
      annotation: simple_duckdb_annotation
    args:
      time_range:
        start: 2024-01-07T00:00:00Z
        end: 2024-03-29T00:00:00Z
    result:
      - time: "2024-02-16T00:00:00Z"
        description: "2nd event"
      - time: "2024-03-27T00:00:00Z"
        description: "3rd event"
  - name: query_time_end_clickhouse_annotation
    resolver: annotations
    properties:
      metrics_view: duckdb_metrics
      annotation: time_end_clickhouse_annotation
    args:
      time_range:
        start: 2024-01-01T00:00:00Z
        end: 2024-03-29T00:00:00Z
    result:
      - time: "2024-01-05T00:00:00Z"
        time_end: "2024-01-09T00:00:00Z"
        description: "1st event"
      - time: "2024-02-16T00:00:00Z"
        time_end: "2024-02-20T00:00:00Z"
        description: "2nd event"
  - name: query_grain_duckdb_annotation
    resolver: annotations
    properties:
      metrics_view: duckdb_metrics
      annotation: grain_duckdb_annotation
    args:
      time_range:
        start: 2024-01-01T00:00:00Z
        end: 2024-03-31T00:00:00Z
      time_grain: 5
    result:
      - time: "2024-01-05T00:00:00Z"
        grain: "day"
        description: "1st event"
        time_grain: 5
      - time: "2024-03-27T00:00:00Z"
        grain: "hour"
        description: "3rd event"
        time_grain: 4